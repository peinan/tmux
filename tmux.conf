#-------------------------------------------------------#
# Genaral
#-------------------------------------------------------#

# Shell
set -g default-terminal ${TERM}
set -g default-shell ${SHELL}

# Enable mouse
set -g mouse on

# Numbering
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on

# Others
set -s escape-time 0
set -g history-limit 10000
set -g monitor-activity on

# Set cursor to Steady Block
set -as terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[2 q'

#-------------------------------------------------------#
# Appearance
#-------------------------------------------------------#

# Colors
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ',xterm-256color:Tc'

# Refresh interval
set -g status-interval 1

# Enable undercurl
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# Status line style (Designed for SF Mono Square)
set -g status on
set -g status-position top
set -g status-justify centre
set -g status-left-length 100
set -g status-style "fg=green,bg=default"
set -g window-status-separator "  "
set -g status-format[0] "#[align=left]#[fg=green,bg=default]#[fg=black,bg=green]󱂇 #{server_sessions}#[fg=green,bg=default] #S#[align=centre]#[fg=cyan,bg=default]#[fg=black,bg=cyan]󱔓 #{session_windows}#[fg=cyan,bg=default] #{W:#[fg=dimgray] #([ #{pane_current_path} = $HOME ] && echo '~' || basename #{pane_current_path}) #W#{?window_zoomed_flag,+,} ,#[fg=cyan] #([ #{pane_current_path} = $HOME ] && echo '~' || basename #{pane_current_path}) #W#{?window_zoomed_flag,+,} } #[align=right]#[fg=green,bg=default]#[fg=black,bg=green]󰍛 3#[fg=green,bg=default]#(top -l 1 | grep -E '^CPU' | sed -E 's/.*usage: ([0-9]+)\..*/\\1/' | xargs printf '%%3d')%%  #(memory_pressure | tail -n 1 | sed -E 's/.* ([0-9]+)%%/\\1/' | xargs printf '%%2d')%%  #(df -h / | tail -1 | awk '{print $4}') "

# Window activity style
set -g window-status-bell-style "fg=yellow,bg=default"
set -g bell-action any

# Pane style
set -g pane-active-border-style "fg=#60728A"
set -g pane-border-lines single
set -g pane-border-style "fg=#3B4252"

# Message Style
set -g message-style "fg=green,bg=default"

# Copy mode
set -g mode-style "bg=#3B4252,fg=#5E81AC"

#-------------------------------------------------------#
# Keybindings
#-------------------------------------------------------#

# Change prefix key
set -g prefix C-a

# C-a C-a to send C-a to program in tmux
bind C-a send-prefix

# Delete default prefix key
unbind C-b

# Restart config file
bind r source-file ~/.config/tmux/tmux.conf \; display " Reloaded!"

# Enable Shift+Enter in Coding Agents
bind -n S-Enter send-keys Escape "[13;2u"

# Open new pane with current path
bind | split-window -c "#{pane_current_path}" -h
bind - split-window -c "#{pane_current_path}" -v
# Open new pane with home path
bind s split-window -h
bind v split-window -v

# Move pane with vim key bind
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
# Move window
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+
# Swap windows
bind -r C-j swap-window -t -1
bind -r C-k swap-window -t +1

# Resize the pane with Prefix+JKHL
# able to resize with Prefix+J,J,J,...
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Rotation panes with Ctrl-q
bind -n C-q select-pane -t :.+
# C-a C-q to send C-q to program in tmux
bind C-q send-keys C-q

# Copy mode (require tmux >= 2.4)
setw -g mode-keys vi
bind v copy-mode \; display "COPY MODE"

# Copy with Prefix+Enter/y
unbind -T copy-mode-vi Enter
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi y     send-keys -X copy-pipe-no-clear "pbcopy"
bind -T copy-mode-vi v     send-keys -X begin-selection

# Paste with Prefix+p
bind p run "pbpaste | tmux load-buffer - && tmux paste-buffer"

# Rename window
bind , command-prompt -I '#W' -p 'Rename window:' "rename-window '%%'"

# Rename session
bind . command-prompt -I '#S' -p 'Rename session:' 'rename-session "%%"'

# Run popup shell
bind P run "tmux-popup-shell"

# Run popup tmux session manager
bind t run "tmux-session-manager"

# Run Lazygit with popup window
bind g display-popup -d "#{pane_current_path}" -w 90% -h 90% -E "lazygit"

#-------------------------------------------------------#
# Plugins
#-------------------------------------------------------#

set-environment -g TMUX_PLUGIN_MANAGER_PATH "${XDG_DATA_HOME}/tmux/plugins/"
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'atomicstack/tmux-resurrect'  # better spinner: https://github.com/tmux-plugins/tmux-resurrect/pull/511
set-option -g @resurrect-spinner-chars '⠋⠙⠹⢸⣸⣰⣤⣆⡇⠏'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

set -g @plugin 'sainnhe/tmux-fzf'
TMUX_FZF_OPTIONS="-p -w 62% -h 38% -m --reverse"

run "${XDG_DATA_HOME}/tmux/plugins/tpm/tpm"
